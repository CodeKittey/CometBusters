<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
    <title>Comet Busters</title>
	<link rel="icon" type="image/png" href="assets/shipLiveIcon.png" sizes="32x32">
	<script type="text/javascript" src="js/phaser.min.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script type="text/javascript">

Planet = function(index, game, player){

	var x = game.world.randomX;
    var y = game.world.randomY;

    this.game = game;
    this.health = 1;
    this.player = player;
    this.alive = true;

	this.planet = game.add.sprite(x, y, 'planet1');
	this.planet.anchor.set(0.5);

	this.planet.name = index.toString();
	game.physics.enable(this.planet, Phaser.Physics.ARCADE);

	this.planet.body.immovable = false;
	this.planet.checkWorldBounds = true;
	this.planet.body.bounce.setTo(1,1);

	this.planet.angle = game.rnd.angle();
}

Planet.prototype.touch = function() {

	this.health -= 1;

	this.planet.kill();
    if (this.health <= 0)
    {
        this.alive = false;

        this.planet.kill();

        return true;
    }

    return false;

}

/*Planet.prototype.update = function() {

    this.shadow.x = this.tank.x;
    this.shadow.y = this.tank.y;
    this.shadow.rotation = this.tank.rotation;

    this.turret.x = this.tank.x;
    this.turret.y = this.tank.y;
    this.turret.rotation = this.game.physics.arcade.angleBetween(this.tank, this.player);

    if (this.game.physics.arcade.distanceBetween(this.tank, this.player) < 300)
    {
        if (this.game.time.now > this.nextFire && this.bullets.countDead() > 0)
        {
            this.nextFire = this.game.time.now + this.fireRate;

            var bullet = this.bullets.getFirstDead();

            bullet.reset(this.turret.x, this.turret.y);

            bullet.rotation = this.game.physics.arcade.moveToObject(bullet, this.player, 500);
        }
    }

};*/
const GAME_X = 1120;
const GAME_Y = 840;
const SHIPSPEED_MAX = 900;
const PLANETSPEED = 100;
const LIVES = 3;
const PLANETSTOTAL = 6;



var game = new Phaser.Game(GAME_X, GAME_Y, Phaser.AUTO, '', { preload: preload, create: create, update: update });

function preload() {

    game.load.image('space', 'assets/stars.gif');
    game.load.image('ship', 'assets/ship.png');
	game.load.image('fire', 'assets/fire.png');
    game.load.image('planet1', 'assets/planet1.png');
    game.load.image('shipLives', 'assets/shipLiveIcon.png');

}

var ship;
var platforms;
var cursors;
var space;
var currentSpeed = 0;
var planet;
var planets;

var score = 0;
var scoreString = '';
var scoreText;
var lives;
var liveCounter = 3;
var firingTimer = 0;
var fire;
var fireButton;
var respawn = false;


function create() {
    //  We're going to be using physics, so enable the Arcade Physics system
    game.physics.startSystem(Phaser.Physics.ARCADE);

    game.add.tileSprite(0, 0, GAME_X, GAME_Y, 'space');
	//  The hero!
	ship = game.add.sprite(500, 350, 'ship');

	ship.anchor.setTo(0.5, 0.5);
	ship.scale.setTo(0.4,0.4);

	game.physics.enable(ship, Phaser.Physics.ARCADE);

	ship.checkWorldBounds = true;
	ship.events.onOutOfBounds.add(resetObject, this);


	//  Our bullet group
    fire = game.add.group();
    fire.enableBody = true;
    fire.physicsBodyType = Phaser.Physics.ARCADE;
	//fire.scale.setTo(0.4,0.4);
    fire.createMultiple(30, 'fire',0, false);
    fire.setAll('anchor.x', 0.5);
    fire.setAll('anchor.y', 0,5);
    fire.setAll('outOfBoundsKill', true);
    fire.setAll('checkWorldBounds', true);

	//The scoreText //  The score
    scoreString = 'Score : ';
    scoreText = game.add.text(10, 10, scoreString + score, { font: '24px Arial', fill: '#fff' });

	lives = [];

	for (var i = 0; i < LIVES; i++)
	{
		var x = 35*i + 10;
		lives[i] = game.add.sprite(x, 40, 'shipLives');
	}

	//planets for everyone
	planets = [];

	for (var i = 0; i < PLANETSTOTAL; i++)
    {
        planets.push(new Planet(i, game, ship));
    }
    //  Our controls.
    cursors = game.input.keyboard.createCursorKeys();
	fireButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
}

function update() {

	for (var i = 0; i < planets.length; i++)
{
	planetsAlive = 0;
	if (planets[i].alive)
	{
		planetsAlive++;
		game.physics.arcade.overlap(ship, planets[i].planet, planetHitsShip, null, this);
		game.physics.arcade.overlap(fire, planets[i].planet, fireHitPlanet, null, this);
		planets[i].planet.events.onOutOfBounds.add(resetObject, this);
		game.physics.arcade.velocityFromRotation(planets[i].planet.rotation, PLANETSPEED, planets[i].planet.body.velocity);

		//planets[i].update();
	}
}
    // Allow the player to jump if they are touching the ground.
	if (cursors.left.isDown)
    {
        ship.angle -= 6;
    }
    else if (cursors.right.isDown)
    {
        ship.angle += 6;
    }

    if (cursors.up.isDown && currentSpeed <= SHIPSPEED_MAX && !respawn)
    {
        //  The speed we'll travel at
        currentSpeed += 20;
    }
    else if (currentSpeed > 0 && !respawn)
    {
            currentSpeed -= 5;
    }
	else
	{
		currentSpeed = 0;
		respawn = false;
	}


    if (currentSpeed >= 0)
    {
        game.physics.arcade.velocityFromRotation(ship.rotation, currentSpeed, ship.body.velocity);
    }

	//  Firing?
	  if (fireButton.isDown)
	  {
		  fireBullet();
	  }

	  //  Run collision
	 // game.physics.arcade.overlap(bullets, aliens, collisionHandler, null, this);

}


function fireBullet () {

    //  To avoid them being allowed to fire too fast we set a time limit
    if (game.time.now > firingTimer)
    {
        //  Grab the first bullet we can from the pool
        _fire = fire.getFirstExists(false);

        if (_fire)
        {
            //  And fire it
            _fire.reset(ship.x, ship.y);

			_fire.checkWorldBounds = true;
		    _fire.outOfBoundsKill = true;

			_fire.rotation = ship.rotation;
			// Shoot it in the right direction
		   _fire.body.velocity.x = Math.cos(_fire.rotation) * 900;
		   _fire.body.velocity.y = Math.sin(_fire.rotation) * 900;

            firingTimer = game.time.now + 100;
        }
    }

}

function planetHitsShip () {
	//TODO Respawn timeout for collision
	//TODO Animations Explosions
	if(!respawn) {
	liveCounter-=1;
	lives[liveCounter].kill();

	if(liveCounter !== 0){
		respawn = true;
		ship.reset(500, 350);

	} else {
		ship.kill();
	}
}

}

function fireHitPlanet (planet, fire) {
	//TODO Animations Explosions
	fire.kill();
	var destroyed = planets[planet.name].touch();
	//planet.touch();
}

function resetObject (object) {
	if(object.x > GAME_X && object.y < GAME_Y){
		object.reset(0,object.y);
	} else if (object.x < GAME_X && object.y > GAME_Y) {
		object.reset(object.x, 0);
	} else if (object.x < 0 && object.y > 0) {
		object.reset(GAME_X, object.y);
	} else {
		object.reset(object.x, GAME_Y);
	}
}


</script>

</body>
</html>
